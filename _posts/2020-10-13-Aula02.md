# NLW-Next-Level-Week #3
# Aula 2 (13/10/2020): Proffy-Server

T√≥picos abordados nesta aula:
- Criando projeto com Node.js
- Rotas par√¢metros e m√©todos HTTP
- Configurando banco de dados
- Criando tabelas no banco
- Criando orfanato sem imagem
- Abstraindo em controller
- Listando orfanatos
- Detalhe do orfanato
- Upload de imagens
- Trabalhando com views
- Lidando com exce√ß√µes
- Valida√ß√£o de dados

Na segunda aula iremos criar uma Web API REST. Para iniciar um projeto, entre na pasta onde o projeto ser√° criado e d√™ o comando:
```bash
npm init -y
```
<p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/install_typescript.png" alt="Image" width="100%" />
</p>

 
Isso ir√° criar um arquivo packages.json no projeto. O par√¢metro ‚Äú-y‚Äù serve para pular as perguntas iniciais como nome e autor do projeto. Ap√≥s isso abra o VS Code e foi criado a depend√™ncias da aplica√ß√£o (packages.json). Como o Node n√£o entende Typescript, somente Javascript, abra um terminal no VS Code e instale a biblioteca typescript com o comando:
```bash
npm install typescript ‚ÄìD
```
 
<p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/npm_init.png" alt="Image" width="100%" />
</p>


Gere o arquivo de configura√ß√£o do Typescript com o comando:
```bash
npx tsc -init
```
 
<p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/npx_tsc.png" alt="Image" width="100%" />
</p>

Definimos a vers√£o do ECMAScript para es2017 pois √© a vers√£o que o Node.js entende. Se fosse uma vers√£o de browser como o IE teria que ser uma vers√£o mais antiga. Instalamos a tamb√©m a depend√™ncia:
```bash
yarn add ts-node-dev -D
```
 
<p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/addnodedev.png" alt="Image" width="100%" />
</p>
 

Que executa o servidor Node, fazendo ele entender Typescript, e monitora se teve altera√ß√£o no Script. Se houver, ele restart automaticamente o servidor. Por padr√£o, sem a extens√£o, ter√≠amos que parar e reiniciar o Node manualmente se houvesse altera√ß√µes.

Para testar o servi√ßo, altere o arquivo packages.json e crie uma se√ß√£o scripts e crie um arquivo src/server.ts com uma mensagem console.log gen√©rica:
 
<p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/server_ts.png" alt="Image" width="100%" />
</p>
 
Observe que esta configura√ß√£o "start": "ts-node-dev src/server.ts" poderia ser abreviada como "start": "tsnd src/server.ts". Para executar no terminai digite:

```bash
yarn start OU npm start
```
 
<p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/npm_start.png" alt="Image" width="100%" />
</p>
 

No script do iremos inserir algumas flags e ficar√° assim:

```bash
"scripts": {
    "dev": "tsnd -
--transpile-only >> Converte Javacript para Typescript, n√£o verifica se tem erros, acelera o desenvolvimento
--ignore-watch node_modules >> N√£o converte c√≥digo dentro da pasta node_modules
--respawn > Funcionamento de se alterar o c√≥digo faz um restart, sen√£o continua rodando e s√≥ sai se der Crtl+C
src/server.ts",
   },
```

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/inserir_ flags.png" alt="Image" width="100%" />
</p>


Abaixo um comparativo das sa√≠das de usando o flag respawn, exemplificando que ele continua rodando...
 
 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/flag_respawn.png" alt="Image" width="100%" />
</p>

Outro exemplo √© que se alterar a sa√≠da, ele atualiza automaticamente:
 
 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/automaticamente.png" alt="Image" width="100%" />
</p>

Por causa dessa funcionalidade temos que abrir outro terminal para instalar outra depend√™ncia o express:
```bash
npm install express
```

O express √© micro-framework que traz algumas funcionalidades prontas que evitam ficar fazendo configura√ß√µes. Ao importar o express no arquivo packages.json aparece a depend√™ncia e a vers√£o instalada.

 
 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/install_express.png" alt="Image" width="100%" />
</p>



O Node, como qualquer outra linguagem back-end, funciona em um sistema de requisi√ß√£o e resposta. Cada vez que o usu√°rio acessa uma rota ou nosso Front-End React faz uma chamada da API. E o Node precisa enviar uma resposta. O Express auxilia na configura√ß√£o de rotas da aplica√ß√£o, e com ele iremos criar a √∫nica aplica√ß√£o no c√≥digo que ficar√° escutando a porta 3333. Altere o arquivo server.ts para ficar como abaixo:

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/porta_3333.png" alt="Image" width="100%" />
</p>


Ao importar o express no arquivo server.ts d√° um erro de depend√™ncia j√° visto anteriormente

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/server_erro.png" alt="Image" width="100%" />
</p> 

Quando estamos trabalhando com typescript, alguns pacotes adicionados s√£o tamb√©m em typescript e outros n√£o. Os que n√£o s√£o a comunidade precisar criar esses pacotes de tipagem (com @type) que precisam ser instaladas tamb√©m.
```bash
npm install @types/express -D
```


Executando o m√©todo get acima, j√° temos a comunica√ß√£o da aplica√ß√£o mas os resultados n√£o saem no navegador.

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/metodo_get.png" alt="Image" width="100%" />
</p> 

Para dar a sa√≠da temos que incluir os 2 par√¢metros que s√£o injetados pelo m√©todo app.get: o request e o response. O request traz informa√ß√µes sobre a requisi√ß√£o (o cabe√ßalho e o corpo, o usu√°rio, e-mail, senha, dados recebidos pelo Front-End). O response √© a resposta da API para a aplica√ß√£o. O c√≥digo fica assim:

```bash
import express from 'express';

const app = express();

app.get("/users", (request, response) =>{
    return response.send('Start on port 3333 üöÄ')
});

app.listen(3333);
```

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/listen_3333.png" alt="Image" width="100%" />
</p> 

Por√©m como trabalhar com formato JSON precisamos fazer algumas altera√ß√µes:

```bash
import express from 'express';

const app = express();

app.get("/users", (request, response) =>{
    const users =[
        {name: 'Diogo', age:25},
        {name: 'Ana', age:25},
    ]

    return response.json(users)
});

app.listen(3333);

```

Para visualizarmos melhor os resultados podemos instalar um plugin no navegador Chrome, JSON Viewer:


### Rotas, Recursos e M√©todos HTTP

Cada endere√ßo √© uma rota (Ex.: http://localhost:3333/users ou http://localhost:3333/contact). O recurso √© qualquer coisa que vem depois da URL base, ou seja, /users e /contact s√£o os recursos. Os m√©todos HTTP de uma API mais comuns s√£o o GET, POST, PUT e DELETE respons√°veis pelas opera√ß√µes de CRUD. Como o pacote express que estamos utilizando parece ter limita√ß√µes para testar outras requisi√ß√µes que n√£o seja GET vamos utilizar outra ferramenta: O [Insomnia Core](https://insomnia.rest/download/). E vamo criar um Workspace para o NLW.

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/insomniadownload.png" alt="Image" width="100%" />
</p> 
 
### Par√¢metros

	Quando fazemos requisi√ß√£o existem 3 tipos de par√¢metros:
‚Ä¢	**request.body**: Para criar ou atualizar um registro, uma informa√ß√£o vem no corpo da requisi√ß√£o.
‚Ä¢	**request.params**: Identifica um recusrso na nossa rota quando for atualizar ou deletar um registro espec√≠fico.
‚Ä¢	**request.query**: Usados principalmente em listagens, para fazer filtros, pagina√ß√£o, ordena√ß√£o, etc.

### RequestBody

Se colocarmos um request.body no m√©todo POST:

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/requestbody.png" alt="Image" width="100%" />
</p> 
 
E no Insomnia enviarmos um novo registro de usu√°rio e colocamos m√©todo POST:
 

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/metodopost.png" alt="Image" width="100%" />
</p> 
 

No terminal retorna undefined pois o express n√£o entende JSON por padr√£o. Corrigimos isso adicionando no arquivo server.ts o m√≥dulo que interpreta o JSON:
app.use(express.json());
 

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/expressjson.png" alt="Image" width="100%" />
</p> 


 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/expressjsonterminal.png" alt="Image" width="100%" />
</p> 
 

### Route Params

Se colocarmos um request.params no m√©todo DELETE:
 
 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/requestparams.png" alt="Image" width="100%" />
</p> 

E no Insomnia enviarmos uma rota com a barra e um id e selecionamos m√©todo DELETE:
```bash
http://localhost:3333/users/1
```

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/localhostusers.png" alt="Image" width="100%" />
</p> 

No terminal retorna

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/localhostusersterminal.png" alt="Image" width="100%" />
</p> 

### Route Query

Se colocarmos um request.query no m√©todo GET:
  

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/requestquery.png" alt="Image" width="100%" />
</p> 


E no Insomnia enviarmos uma rota com a query:
```bash
http://localhost:3333/users?page=20&name=Bob
```

 
 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/rotaquery.png" alt="Image" width="100%" />
</p> 

No terminal retorna

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/rotaqueryterminal.png" alt="Image" width="100%" />
</p> 


### Criando o Banco de Dados

Existem 3 formas de lidar com banco de dados no Back-End:
1.	**Driver nativo**: Permite realizar query direto com o Node mas n√£o possui camada de abstra√ß√£o. Por exemplo, ter√≠amos que escrever a query no SQLite no formato padr√£o de consultas SQL.

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/drivernativo.png" alt="Image" width="100%" />
</p> 

2.	**Query Builder**: O mais famoso √© o KnexJS utilizado na NLW#2. Aqui escremos nossas querys com Javascript

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/querybuilder.png" alt="Image" width="100%" />
</p> 

3.	**ORM (Object Relational Mapper)**: Temos o maior n√≠vel de abstra√ß√£o. Teremos uma classe em Javascript que simboliza uma tabela. Para cada tabela no BD teremos uma classe na aplica√ß√£o. A sintaxe de consulta √© igual do Query Builder, utilizando Javascript. Podemos atualizar a classe, excluindo, alterando e adicionando campos e se reflitira no BD.

Vamos executar um comando para instalar o typeorm e o sqlite3.
```bash
npm install typeorm sqlite3
```

TypeORM √© um ORM que pode ser executado nas plataformas NodeJS, Browser, Cordova, PhoneGap, Ionic, React Native, NativeScript, Expo e Electron e pode ser usado com TypeScript e JavaScript (ES5, ES6, ES7, ES8). Seu objetivo √© sempre oferecer suporte aos recursos JavaScript mais recentes e fornecer recursos adicionais que o ajudem a desenvolver qualquer tipo de aplicativo que use bancos de dados - desde pequenos aplicativos com algumas tabelas at√© aplicativos corporativos de grande escala com v√°rios bancos de dados.

TypeORM suporta os padr√µes Active Record e Data Mapper, ao contr√°rio de todos os outros ORMs JavaScript existentes atualmente, o que significa que voc√™ pode escrever aplicativos de alta qualidade, fracamente acoplados, escal√°veis e sustent√°veis da maneira mais produtiva. TypeORM √© altamente influenciado por outros ORMs, como Hibernate, Doctrine e Entity Framework.

Em seguida, criamos uma pasta databases dentro de src e adicionamos 2 arquivos, o database.sqlite e connectios.ts e uma pasta chamada migrations. No arquivo connect digite o seguinte c√≥digo para criar a conex√£o:

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/criarconexao.png" alt="Image" width="100%" />
</p> 

 E fazemos a importa√ß√£o dentro do arquivo server.ts. Por fim, execute a aplica√ß√£o para ver se n√£o h√° nenhum erro de refer√™ncia dos arquivos.

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/refarquivos.png" alt="Image" width="100%" />
</p> 

Al√©m de instalar o typeorm, precisamos adicionar um arquivo ormconfig.json que conter√° as informa√ß√µes m√≠nimas de conex√£o com o BD.

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/ormconfig.png" alt="Image" width="100%" />
</p> 

### Migrations

Controlam as vers√µes dentro do banco de dados, similar ao Git. Por isso que vamos montar a estrutura do BD utilizando essa ferramenta. Quando outro desenvolvedor for trabalhar no mesmo projeto o Migrations reconstr√≥i o banco na sua vers√£o mais atualizada.

Quando instalamos o TypeORM ele fornece uma interface de linha de comando que pode ser consultada pelo comando:
```bash
npx typeorm
```
 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/npxtypeorm.png" alt="Image" width="100%" />
</p> 

Caso, ao executar este comando, aparece de resultado typeorm inv√©s de cli.js, voc√™ ter√° que criar um comando customizado no arquivo packages.json.

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/resultadotypeorm.png" alt="Image" width="100%" />
</p> 

Precisar√° incluir na se√ß√£o scripts a seguinte linha:
```bash
"typeorm": "ts-node-dev ./node_modules/typeorm/cli.js"
```

<p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/typeormclijs.png" alt="Image" width="100%" />
</p> 

No arquivo ormconfig.json iremos indicar os diret√≥tios de nossa migrations:
 
 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/nossamigrations.png" alt="Image" width="100%" />
</p> 

- **Migrations**: √© onde se localiza os arquivos typescript gerado pelo migrations. 
- **Entities**: indica onde estar√£o nossas classes abstratas.
- **migrationsDir**: indica o diret√≥rio de de refer√™ncias de cria√ß√£o das migrations. 

Rode o seguindo comando para criarmos a nossa migration de orfanatos:
```bash
npx typeorm migration:create -n create_orphanages
```

Ser√° gerado um arquivo com uma timestamp com os m√©todos:
- **Up**: Executa o especificado (pelo par√¢metro config.name) ou a pr√≥xima migra√ß√£o cronol√≥gica que ainda n√£o foi executada.
- **Down**: Desfaz o especificado (pelo par√¢metro config.name) ou a √∫ltima migra√ß√£o que foi danificada

No arquivo gerado codifique a cria√ß√£o da tabela conforme a seguir:

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/arquivogerado.png" alt="Image" width="100%" />
</p> 

 
Na NLW#2 hav√≠amos utilizado a Extens√£o SQLite abaixo, para verificar a execu√ß√£o do migrations e as grava√ß√µes das tabelas.

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/extens√£osqlite.png" alt="Image" width="100%" />
</p> 


Mas como essa extens√£o d√° muitos problemas na hora de visualizar os dados e tem que ficar dando RELOAD no VS Code e reiniciando a aplica√ß√£o, iremos utilizar nesta edi√ß√£o o [Beekeeper Studio](https://www.beekeeperstudio.io/).

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/beekeeperstudio.png" alt="Image" width="100%" />
</p> 

Depois de instalado o Beekeeper Studio, precisamos definir algumas configura√ß√µes:

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/beekeeperstudioconf.png" alt="Image" width="100%" />
</p> 

No campo Database file, navegue at√© o diret√≥rio da aplica√ß√£o e selecione o arquivo database.sqlite criado anteriormente:

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/databasesqlite.png" alt="Image" width="100%" />
</p> 

Salve a conex√£o com o nome que desejar, aqui colocamos NLW #03. De volta ao VS Code, execute o seguinte comando para criar a tabela:
```bash
npm run typeorm migration:run
```

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/migrationrun.png" alt="Image" width="100%" />
</p> 

E podemos ver que foi criado 3 tabelas:
- **Migrations**: armazena quais migrations foram executadas.
- **Orphanages**: a tabela criada
- **Sqlite_sequence**: uma tabela auxiliar para controle do incremento 

Para come√ßarmos a fazer a abstra√ß√£o de nossa tabela para aplica√ß√£o precisamos alterar algumas configura√ß√µes no arquivo tsconfig.json:
- **strictPropertyInitialization**: false, habilita a verifica√ß√£o estrita da inicializa√ß√£o da propriedade nas classes. 
- **experimentalDecorators**: true,  Ativa o suporte experimental para decoradores ES7.
- **emitDecoratorMetadata**: true, Ativa o suporte experimental para a emiss√£o de metadados de tipo para decoradores. 

O Decorator habilita um API muito utilizada em Java e no Typescript (mas n√£o dispon√≠vel no Javascript). O Decorator √© utilizado em classes, propriedades ou fun√ß√µes. Crie um arquivo Orphanage.ts dentro de uma pasta models dentro de src.

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/orphanagets.png" alt="Image" width="100%" />
</p> 

Os atributos Entity, Colum s√£o os Decorators que vinculam nossa tabela orphanages com essa classe Orphanage. Se n√£o tiv√©ssemos feito as altera√ß√µes no arquivo tsconfig.json estaria dando um seguintes erros de Decorator:
 

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/atributosentity.png" alt="Image" width="100%" />
</p> 

E o erro de a verifica√ß√£o estrita da inicializa√ß√£o:

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/verificacaoestrita.png" alt="Image" width="100%" />
</p> 


### Criando orfanato sem imagem

Para criar um novo registro vamos voltar ao Insomnia e criar uma requisi√ß√£o:
 
 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/novoregistro.png" alt="Image" width="100%" />
</p> 
 
Na url definimos o m√©todo POST para o recurso orphanages, com o RequestBody em JSON passando o dados. De volta ao VS Code iremos trabalhar no arquivo server.ts. Primeiro execute o projeto com npm start e adicione um console log para verificarmos se os dados est√£o sendo transmitidos quando enviamos a requisi√ß√£o pelo Insomnia:

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/recursoorphanages.png" alt="Image" width="100%" />
</p> 

Altere o arquivo server.ts para ficar assim:
 
 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/altereserver.png" alt="Image" width="100%" />
</p> 

O TypeORM utiliza o Design Pattern Repository em que toda opera√ß√£o do BD passa por um reposit√≥rio que define as regras de como um dado pode ser criado, exclu√≠do, etc. Conseguimos isso fazendo a importa√ß√£o do componente getReposit√≥rio que ira dispor os m√©todos create e save utilizados acima. Se n√£o houver nenhum erro, ao enviarmos a requisi√ß√£o do Insomnia agora teremos o registro gravado conforme podemos confirmar no BeeKeeper Studio:
 
 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/confirmarbeekeeper.png" alt="Image" width="100%" />
</p> 

### Abstraindo em controller

Por crit√©rio de organiza√ß√£o iremos criar um arquivo routes.ts para retirar o c√≥digo de rotas que estava dentro de server:

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/retirarcodigo.png" alt="Image" width="100%" />
</p> 

Como est√° em um arquivo separado utilizamos express.Router() (anteriormente as rotas eram constru√≠das diretamente atrav√©s de express). Isso possibilita as rotas serem chamadas e utilizadas em diversas partes do projeto. Como indicado acima tamb√©m devemos criar uma pasta controllers com um arquivo OrphanageControllers.ts pois estaremos adotando a arquitetura MVC (Model, View e Controller) para organiza√ß√£o do c√≥digo.
 
 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/arquiteturamvc.png" alt="Image" width="100%" />
</p> 


Ap√≥s a refatora√ß√£o do c√≥digo, verifique pelo Insomnia se ainda est√° funcionando a grava√ß√£o do orfanato:
 
 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/refatoracao.png" alt="Image" width="100%" />
</p> 

### Listando orfanatos e Detalhe do orfanato

Para criar a listagens de orfanatos temos que criar o m√©todo dentro do controller, vamos chama-lo de index:
 
 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/criarlistagens .png" alt="Image" width="100%" />
</p> 

Se precis√°ssemos incluir filtros na lista, poder√≠amos com o atalho Ctrl + espa√ßo visualizar as op√ß√µes dentro das chaves. Da mesma forma criamos o nosso m√©todo de detalhes:

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/filtroslista.png" alt="Image" width="100%" />
</p> 

Incluimos as duas rotas no arquivo routes.ts


 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/duasrotas.png" alt="Image" width="100%" />
</p> 


E testamos novamente no Insomnia:
 

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/testamosnovamente.png" alt="Image" width="100%" />
</p> 


Caso ocorrer algum erro no Insomnia √© poss√≠vel analisar o problema no terminal do VS Code:

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/algumerro.png" alt="Image" width="100%" />
</p> 

### Upload de imagens

A regra de neg√≥cios da aplica√ß√£o define que um orfanato pode ter v√°rias imagens. Portanto iremos criar outra tabela, por√©m n√£o iremos armazenar os arquivos no banco de dados, mas somente os nomes. O arquivo ser√° armazenado no diret√≥rio da aplica√ß√£o. Rode o seguindo comando para criarmos a nossa migration de imagens:

```bash
npx typeorm migration:create -n create_images
```

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/create_images.png" alt="Image" width="100%" />
</p> 


Nessa tabela devemos ter o relacionamento 1 para muitos, por inclu√≠mos o campo orphanage_id. Incluimos tamb√©m as opera√ß√µes Cascade, que atualizar√° automaticamente a tabela images, caso o orfanato seja alterado ou exclu√≠do. O script para cria√ß√£o da tabela no arquivo criado fica como abaixo:
 
 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/operacoescascade.png" alt="Image" width="100%" />
</p> 

Execute o comando abaixo para criar a tabela e verifique no BeeKeeper Studio se foi criada:
```bash
npm run typeorm migration:run
```

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/verifiquetabela.png" alt="Image" width="100%" />
</p> 

Precisamos agora instalar uma biblioteca que lida com upload de arquivos no Node chamada Multer:

```bash
npm install multer
```

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/installmulter.png" alt="Image" width="100%" />
</p> 
 

Depois, dentro do src, criamos uma pasta config e um arquivo de configura√ß√£o do multer:

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/dentrodosrc.png" alt="Image" width="100%" />
</p> 

O par√¢metro storage temos memorystorage, diskstorage e podia ser qualquer servi√ßo de CDN (Rede de fornecimento de conte√∫do) com Google Cloud ou Amazon S3. O diskstorage precisa de dois par√¢metros que √© o destinate e filename. No destinate utilizamos o __dirname que √© o diret√≥rio atual do arquivo e temos que subir dois n√≠veis at√© chegar na pasta uploads.
No filename recebemos uma requisi√ß√£o, o nome do arquivo e um call-back, essa fun√ß√£o evita que usu√°rios utilizem o mesmo nome de arquivos, atribuindo aos nomes um timestamp.

No arquivo route.ts temos que incluir o envio das imagens na rota:


 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/enviodasimagens.png" alt="Image" width="100%" />
</p> 
 

Para testar no Insomnia, como o RequestBody em JSON s√≥ permite texto ou n√∫mero e n√£o permite a utiliza√ß√£o de arquivos, temos que alterar o tipo de envio para Multipart Form.
 

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/permitetexto.png" alt="Image" width="100%" />
</p> 

Ao enviar a requisi√ß√£o pelo Insomnia, agora est√° gravando as imagens na pasta uploads.

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/pastauploads.png" alt="Image" width="100%" />
</p> 

Repare que os arquivos s√£o passados pelo request.files e n√£o mais por request.body, se dermos um console.log retornaria a seguintes informa√ß√µes dos arquivos enviados:

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/requestfiles.png" alt="Image" width="100%" />
</p> 
 
```bash
fieldname: 'images',
originalname: 'profile.png',
encoding: '7bit',
mimetype: 'image/png',
destination: 'C: \\NLW-3\\aulas\\aula2\\server\\uploads',
filename: '1602686395796-profile.png',
path: 'C:\\ NLW-3\\aulas\\aula2\\server\\uploads\\1602686395796-profile.png',
size: 23483
```

Vamos agora tratar da grava√ß√£o na tabela Images, primeiro temos que criar o arquivo de mapeamento Image.ts na pasta models.

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/pastamodels.png" alt="Image" width="100%" />
</p> 
 

E no arquivo Orphanages.ts criamos a vinculo com a tabela Images.ts. 
 
 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/criamosvinculo.png" alt="Image" width="100%" />
</p> 
 
Para adicionarmos as refer√™ncias da imagens no BD precisamos alterar o m√©todo create do OrphanagesController.ts :
 
 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/alterarmetodo.png" alt="Image" width="100%" />
</p> 
 
Ao reenviarmo a requisi√ß√£o pelo Insomnia temos:

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/reenviarmosinsomnia.png" alt="Image" width="100%" />
</p> 
 

E pelo BeeKeeper Studio podemos confirmar a grava√ß√£o dos registros com o relacionamento com a tabela orphanages (id=7):

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/relacionamentotabela.png" alt="Image" width="100%" />
</p> 
 

Se n√£o fizermos isso, ter√≠amos ainda a op√ß√£o de incluir manualmente as imagens, informando o id do orfanato, ap√≥s a grava√ß√£o de um orfanato.
 
 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/incluirmanualmente .png" alt="Image" width="100%" />
</p> 
 
Por fim, para adicionarmos para incluir as imagens nos nossos m√©todos de recupera√ß√£o de dados inclu√≠mos o seguinte no m√©todo find e findOneorFall:

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/metodofind.png" alt="Image" width="100%" />
</p> 
 
### Trabalhando com views

As views aqui ir√£o definir os dados que precisamos voltar ao Front-End, evitando enviar todos os dados da tabela do BD. Crie um pasta views dentro de src e dois arquivos para cada tabela que retornaremos dados, images_view.ts e orphanages_view.ts.

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/pastaviews.png" alt="Image" width="100%" />
</p> 
 

No arquivo images_view podemos utilizar as vari√°veis de ambiente para ocultar a informa√ß√£o da rota. Para isso √© necess√°rio criar o arquivo .env e colocar no gitignore, como vimos anteriormente.
 
 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/images_view.png" alt="Image" width="100%" />
</p> 
 
E no controller alteramos o retorno do m√©todo:
 
 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/controller.png" alt="Image" width="100%" />
</p> 
  

Pelo link gerado de retorno agora, conseguimos acessar as imagens gravadas.

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/linkgerado.png" alt="Image" width="100%" />
</p> 
 

### Lidando com exce√ß√µes

O Express tem uma limita√ß√£o quando a resposta de uma requisi√ß√£o √© ass√≠ncrona ele n√£o consegue capturar os erros. Para corrigir isso precisamos instalar um pacote adicional:
```bash
npm install express-async-errors
```

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/expressasync.png" alt="Image" width="100%" />
</p> 
 

Ao importar o pacote no arquivo server.ts

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/importarpacote.png" alt="Image" width="100%" />
</p> 
 

Come√ßa a retornar a mensagem de erro no Insonmia ao ocorrer erro.

 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/mensagemerro .png" alt="Image" width="100%" />
</p> 
 

Para formatar a mensagem de erro precisamos de um Exception Handler. Para isso, crie uma pasta erros e dentro dela um arquivo handler.ts.
 
 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/exceptionhandler.png" alt="Image" width="100%" />
</p> 
 

Aqui estamos pegando a mensagem de erro original e direcionando a sa√≠da dela para o console.log. E para a sa√≠da em tela enviamos uma resposta de erro interno (Status 500)
 
 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/errooriginal.png" alt="Image" width="100%" />
</p> 
 

### Valida√ß√£o de dados

Vamos instalar o Yup para fazer a rotinas de valida√ß√£o:
npm install yup

 
 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/installyup.png" alt="Image" width="100%" />
</p> 
 

Yup √© um validador de esquema de objeto JavaScript. Maneira mais simples de usar Yup
- Defina o esquema do objeto e sua valida√ß√£o
- Crie um objeto validador usando Yup com o esquema e valida√ß√£o esperados
- Use a fun√ß√£o de utilit√°rio Yup "validate" para verificar se os objetos s√£o v√°lidos (satisfaz o esquema e as valida√ß√µes)

No arquivo OrphanageCotroller.ts ficar√° a valida√ß√£o Yup da seguinte maneira:
 
 
 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/validacaoyup .png" alt="Image" width="100%" />
</p> 
 

No arquivo handler.ts precisamos fazer a diferencia√ß√£o de erros de valida√ß√£o com os erros de execu√ß√£o:

 
 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/arquivohandler.png" alt="Image" width="100%" />
</p> 
  
Ao enviarmos a requisi√ß√£o sem o campos nome e about que s√£o obrigat√≥rios, retorna os erros de valida√ß√£o:
 
 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/nomeabout.png" alt="Image" width="100%" />
</p> 
 
Para finalizar, adicionamos o pacote cors, que permite que aplica√ß√µes em endere√ßos diferentes, no caso, nosso Front-End esteja no localhost:3000 e seja acessado pela API Back End em localhost:3333. Por padr√£o, s√≥ permite o acesso de aplica√ß√µes no mesmo endere√ßo a API.
```bash
yarn add cors
```
 <p align="center">
  <img src="https://raw.githubusercontent.com/shyoutarou/NLW-Next-Level-Week-3/master/.github/addcors.png" alt="Image" width="100%" />
</p> 
 



